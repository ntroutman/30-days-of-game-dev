---
layout: post
title:  "Day 4: Create a Key Item and Use it to Open a Door"
date:   2019-11-10 00:00:00 -0000
---

After following some the guide from Day 3.5 I thought this should be a piece of cake.

1. Create a new child class of BP_BaseInteractable called "BP_Door"
2. Add a function "ShouldOpen?" which returns a single boolean defaulting to "True", this method would allow arbitrary conditions for child classes, such as keys.
3. Make a new child class of BP_Door called "BP_KeyCard_Door" which has a variable of type "BP_BaseItem" that will be the key card that has to be in the player's inventory
4. Override "ShouldOpen?" in BP_KeyCard_Door to check the player's inventory for the needed key card.
5. Done!

This ended up take several hours due to a whole slew of reasons.

![BP_Door Blueprint - Event graph]({{site.baseurl}}/assets/image/day4/BP_Door.jpg)
*The event graph for BP_Door, shows calling 'Should Open?' to determine if the door will respond.*

![BP_Door Blueprint - Should Open?]({{site.baseurl}}/assets/image/day4/BP_Door_ShouldOpen.jpg)
*Default implementation of Should Open? for BP_Door, always 'True'.*


### Inventory Checking

In initially I had written the key card door's Should Open method by simply casting the instigator of the interaction to MyCharacter, grabbing the Inventory array and checking if if contained the ItemInfo of the referenced Key actor. Apparently, checking if a struct is in an array of structs is kind of broken. I couldn't get it to work. After a lot of futzing around I ended up decided to re-architect my code a bit. This included two things, adding an "ItemId" to ItemInfo and adding anew "Inventory Component"

### A New Inventory Component

Instead of burying the inventory as a variable inside of the character class and filling that class up with inventory specific methods, I decided to create a new Actor Component called "Inventory" which would hold the whole inventory subsystem for tracking what is in an inventory. This mean that when the "Pickup" event was called on the character it simply called "Add Item" on the attached inventory component. 

![Blueprint: BP_BaseItem: Interact]({{site.baseurl}}/assets/image/day4/BP_BaseItem_Interact.png)
*Interacting with a BaseItem calls 'Pickup' on the character.*

![Blueprint: MyCharacter: Pickup]({{site.baseurl}}/assets/image/day4/MyCharacter_Pickup.png)
*Add Item is called on the Inventory when the player picks up an item. Not the item is only destroyed if it was successfully picked up and added to the inventory.*

![Blueprint: BPC_Inventory: Add Item]({{site.baseurl}}/assets/image/day4/BPC_Inventory_AddItem.png)
*The inventory attempts to add the requested item to the inventory if there is room, it returns a success/fail depending on if it was successfully added.*

This also meant that the Key Card door didn't need to know how to check the player's inventory instead it got the Inventory Component from the character and as it "Contains Item?" with the key card ItemInfo. Inside of the "Contains Item?" function on the inventory it would iterate over all the items and check if the requested item's ItemId matched any item, if so then return "True", and "False" otherwise. 

![Blueprint: BPC_Inventory: Contains Item?]({{site.baseurl}}/assets/image/day4/BPC_Inventory_ContainsItem.jpg)
*The "Contains Item?" function checks by ItemId, a Name type variable on ItemInfo*


### The Final Door

Once the inventory component was up and working then creating the Key Card door was as easy as expected. Simply create a new BP_KeyCard_Door extending BP_Door and override "Should Open?" to check if a specific item was in the players inventory or not. The Key item is a public Variable on BP_KeyCard_Door pointing to an instance of BP_BaseItem. The only really special thing is that the Key item is an Actor of type BP_BaseItem, but the Inventory Component holds ItemInfo structs, not Actors. This means that on BeginPlay the door pulls out the ItemInfo struct from the Key item for later checking if the player has it in their inventory.

![BP_KeyCardDoor_Door Blueprint - Event graph]({{site.baseurl}}/assets/image/day4/BP_KeyCard_Door_BeginPlay.png)
*Begin Play extracts the ItemInfo from the key actor and stores it for latter use.*

![BP_Door Blueprint - Event graph]({{site.baseurl}}/assets/image/day4/BP_KeyCard_Door_ShouldOpen.jpg)
*The overridden version of 'Should Open?' that shows the check for the key item info in the players inventory.*
