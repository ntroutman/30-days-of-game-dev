---
layout: post
title:  "Day 4: Create a Key Item and Use it to Open a Door"
date:   2019-11-10 00:00:00 -0000
---

After following the guide from Day 3.5 I thought this should be a piece of cake.

1. Create a new child class of BP_BaseInteractable called "BP_Door"
2. Add a function "ShouldOpen?" which returns a single boolean defaulting to "True", this method would allow arbitrary conditions for child classes, such as keys.
3. Make a new child class of BP_Door called "BP_KeyCard_Door" which has a variable of type "BP_BaseItem" that will be the key card that has to be in the player's inventory in order for the door to open.
4. Override "ShouldOpen?" in BP_KeyCard_Door to check the player's inventory for the needed key card.
5. Done!

This ended up take several hours due to a whole slew of reasons.

### The Door

Lets start with the door. I redid the door from Day 2 to make a sliding door instead of a rotating door. The door blueprint also contains a "Should Open?" method which returns true/false if the door determines it can be opened or not. It also has a "Should Close?" that behaves the same for closing.

{% figure img:BP_Door.jpg %}
The event graph for BP_Door, shows calling 'Should Open?' to determine if the door will respond
{% endfigure %}

{% figure alt:"BP_Door Blueprint - Should Open" img:BP_Door_ShouldOpen.jpg %}
Default implementation of Should Open? for BP_Door, always 'True'.
{% endfigure %}

### Inventory Checking

Initially I had written the key card door's "Should Open" method by simply casting the instigator of the interaction to MyCharacter, grabbing the Inventory array and checking if if contained the ItemInfo of the referenced Key actor. Apparently, checking if a struct is in an array of structs is kind of broken. I couldn't get it to work. After a lot of futzing around I ended up decided to re-architect my code a bit. This included two things, adding an "ItemId" to ItemInfo and adding a new "Inventory" blueprint component.

### A New Inventory Component

Instead of burying the inventory as a variable inside of the character class and filling that class up with inventory specific methods, I decided to create a new Actor Component called "BPC_Inventory" which would hold the whole inventory subsystem for tracking what is in an inventory, checking the contents, stacking, checking if there is room, etc. This meant that when the "Pickup" event was called on the character it simply called "Add Item" on the attached inventory component. 

{% figure alt:"Blueprint: BP_BaseItem: Interact" img:BP_BaseItem_Interact.png %}
Interacting with a BaseItem calls 'Pickup' on the character.
{% endfigure %}

{% figure alt:"Blueprint: MyCharacter: Pickup" img:MyCharacter_Pickup.png %}
*"Add Item" is called on the Inventory when the player picks up an item. Note, the item is only destroyed if it was successfully picked up and added to the inventory.
{% endfigure %}

{% figure alt:"Blueprint: BPC_Inventory: Add Item" img:BPC_Inventory_AddItem.png %}
*The inventory attempts to add the requested item to the inventory if there is room, it returns a success/fail depending on if it was successfully added.
{% endfigure %}

This also meant that the Key Card door didn't need to know how to check the player's inventory instead it got the Inventory Component from the character and calls "Contains Item?" with the key card ItemInfo. Inside of the "Contains Item?" function on the inventory it would iterate over all the items and check if the requested item's ItemId matched any item, if so then return "True", or "False" otherwise. 

{% figure alt:"Blueprint: BPC_Inventory: Contains Item?" img:BPC_Inventory_ContainsItem.jpg %}
*The "Contains Item?" function checks by ItemId, a Name type variable on ItemInfo
{% endfigure %}


### The Final Door

Once the inventory component was up and working, then creating the Key Card door was as easy as expected. Simply create a new BP_KeyCard_Door extending BP_Door and override "Should Open?" to check if a specific item was in the players inventory or not. The Key item is a public Variable on BP_KeyCard_Door pointing to an instance of BP_BaseItem. The only really special thing is that the Key item is an Actor of type BP_BaseItem, but the Inventory Component holds ItemInfo structs, not Actors. This means that on BeginPlay the door pulls out the ItemInfo struct from the Key item for later checking if the player has it in their inventory.

{% figure alt:"BP_KeyCardDoor_Door Blueprint - Event graph" img:BP_KeyCard_Door_BeginPlay.png %}
*Begin Play extracts the ItemInfo from the key actor and stores it for latter use.
{% endfigure %}

{% figure alt:"BP_Door Blueprint - Event graph" img:BP_KeyCard_Door_ShouldOpen.jpg %}
*The overridden version of 'Should Open?' that shows the check for the key item info in the players inventory.
{% endfigure %}
